<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Journal App</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Gaegu:wght@300;400;700&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
          rel="stylesheet"/>
    <style type="text/tailwindcss">
        :root {
            --primary-color: #f4b4c4;
            --background-light: #fff8f9;
            --background-dark: #2a3141;
            --text-light: #52474a;
            --text-dark: #e8dee1;
            --accent-color: #f7d9a1;
        }

        body {
            font-family: 'Gaegu', cursive;
        }

        .material-symbols-outlined {
            font-variation-settings: 'FILL' 1,
            'wght' 400,
            'GRAD' 0,
            'opsz' 24
        }

        .scribble-button {
            border: 2px solid var(--text-light);
            border-radius: 15px 225px 255px 15px 15px 255px 225px 15px;
            transition: all 0.3s ease-in-out;
        }

        .scribble-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }

        .speech-bubble {
            border-radius: 20px;
            border: 2px solid var(--primary-color);
            box-shadow: 0 4px 12px rgba(244, 180, 196, 0.3);
        }

        .speech-bubble:after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 24px;
            width: 0;
            height: 0;
            border: 15px solid transparent;
            border-top-color: var(--primary-color);
            border-bottom: 0;
            margin-left: -15px;
            margin-bottom: -15px;
        }

        .speech-bubble-inner:after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 24px;
            width: 0;
            height: 0;
            border: 15px solid transparent;
            border-top-color: var(--background-light);
            border-bottom: 0;
            margin-left: -15px;
            margin-bottom: -13px;
        }

        .dark .speech-bubble:after {
            border-top-color: var(--primary-color);
        }

        .dark .speech-bubble-inner:after {
            border-top-color: var(--background-dark);
        }

        .dark .scribble-button {
            border-color: var(--text-dark);
        }

        @media (prefers-color-scheme: dark) {
            .scribble-button {
                border-color: var(--text-dark);
            }
        }
    </style>
</head>
<body class="bg-[var(--background-light)] dark:bg-[var(--background-dark)] text-[var(--text-light)] dark:text-[var(--text-dark)] antialiased">
<div class="relative min-h-screen" id="app" x-data="journalApp()" x-init="init()">
    <main :class="{'ml-0 md:ml-80': entriesSidebarOpen}"
          class="h-screen w-screen flex flex-col p-4 sm:p-6 md:p-8 transition-all duration-300">
        <header class="flex-shrink-0 flex justify-between items-center pb-4">
            <div class="flex items-center gap-4">
                <div class="relative">
                    <button @click="mainMenuOpen = !mainMenuOpen"
                            class="p-3 text-[var(--text-light)] dark:text-[var(--text-dark)] hover:text-[var(--primary-color)] dark:hover:text-[var(--primary-color)] transition-colors scribble-button border-[var(--text-light)]/50 dark:border-[var(--text-dark)]/50">
<span class="material-symbols-outlined">
                menu
              </span>
                    </button>
                    <div @click.away="mainMenuOpen = false"
                         class="absolute top-full left-0 mt-2 w-48 bg-[var(--background-light)] dark:bg-[var(--background-dark)] rounded-lg shadow-lg border-2 border-[var(--primary-color)]/50"
                         style="display: none;" x-show="mainMenuOpen"
                         x-transition:enter="transition ease-out duration-200"
                         x-transition:enter-end="opacity-100 transform translate-y-0"
                         x-transition:enter-start="opacity-0 transform -translate-y-2"
                         x-transition:leave="transition ease-in duration-150"
                         x-transition:leave-end="opacity-0 transform -translate-y-2"
                         x-transition:leave-start="opacity-100 transform translate-y-0">
                        <button type="button"
                                @click="window.location.assign('/profile')"
                                class="block w-full text-left px-4 py-3 text-lg hover:bg-[var(--primary-color)]/20 transition-colors">
                            Profile
                        </button>
                        <button type="button"
                                @click="logout()"
                                class="block w-full text-left px-4 py-3 text-lg hover:bg-[var(--primary-color)]/20 transition-colors">
                            Logout
                        </button>
                    </div>
                </div>
                <button @click="entriesSidebarOpen = !entriesSidebarOpen"
                        class="relative p-3 text-[var(--text-light)] dark:text-[var(--text-dark)] hover:text-[var(--primary-color)] dark:hover:text-[var(--primary-color)] transition-colors scribble-button border-[var(--text-light)]/50 dark:border-[var(--text-dark)]/50">
<span class="material-symbols-outlined">
              menu_book
            </span>
                    <span class="absolute -top-2 -right-2 bg-[var(--accent-color)] text-[var(--text-light)] text-sm font-bold w-6 h-6 flex items-center justify-center rounded-full shadow-md"
                          x-show="entries.length &gt; 0" x-text="entries.length"
                          x-transition:enter="transition ease-out duration-300"
                          x-transition:enter-end="opacity-100 scale-100"
                          x-transition:enter-start="opacity-0 scale-50"></span>
                </button>
                <button @click="createNewEntry()"
                        class="p-3 text-[var(--text-light)] dark:text-[var(--text-dark)] hover:text-[var(--primary-color)] dark:hover:text-[var(--primary-color)] transition-colors scribble-button border-[var(--text-light)]/50 dark:border-[var(--text-dark)]/50">
<span class="material-symbols-outlined">
                    add
                </span>
                </button>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-2xl font-bold text-[var(--text-light)] dark:text-[var(--text-dark)] hidden sm:block"
                     x-text="editingIndex !== null ? formatDate(entries[editingIndex].date, entries[editingIndex].editedDate) : 'My Soul Notes'">
                </div>
            </div>
        </header>
        <div class="flex-grow flex flex-col border-t-2 border-[var(--text-light)]/10 dark:border-[var(--text-dark)]/10">
            <div class="flex-grow flex items-center justify-center pt-4">
                <textarea
                        class="w-full max-w-4xl h-full bg-transparent border-0 focus:ring-0 resize-none text-2xl sm:text-3xl leading-loose placeholder-[var(--text-light)]/40 dark:placeholder-[var(--text-dark)]/40"
                        placeholder="What's on your mind, sweet pea?" x-model="currentEntryContent"></textarea>
            </div>
        </div>
        <footer class="flex-shrink-0 pt-4 flex justify-center">
            <button :disabled="saving || currentEntryContent.trim() === ''" @click="saveEntry()"
                    class="relative scribble-button bg-[var(--primary-color)]/80 hover:bg-[var(--primary-color)] text-[var(--text-light)] dark:text-[var(--text-dark)] font-bold py-3 px-6 text-lg transition-all overflow-hidden disabled:opacity-50">
<span :class="{ 'opacity-0 -translate-y-2': saving, 'transition-all duration-300': true }"
      class="flex items-center gap-2">
<span class="material-symbols-outlined" x-text="editingIndex !== null ? 'edit' : 'cloud_upload'"></span>
<span x-text="editingIndex !== null ? 'Update' : 'Save'"></span>
</span>
                <span :class="{ 'opacity-100 translate-y-0': saving, 'opacity-0 translate-y-2': !saving }"
                      class="absolute inset-0 flex items-center justify-center transition-all duration-300">
            Saving...
          </span>
            </button>
        </footer>
    </main>
    <aside :class="{ '-translate-x-full': !entriesSidebarOpen, 'translate-x-0': entriesSidebarOpen }"
           class="fixed top-0 left-0 h-full w-full md:w-80 bg-[var(--background-light)] dark:bg-[var(--background-dark)] border-r-2 border-[var(--primary-color)]/30 shadow-2xl transform transition-transform duration-300 ease-in-out z-10">
        <div class="p-6 h-full flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Past Entries</h2>
                <button @click="entriesSidebarOpen = false"
                        class="p-2 hover:text-[var(--primary-color)] transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="flex-grow overflow-y-auto space-y-4">
                <template x-if="entries.length === 0">
                    <p class="text-center text-[var(--text-light)]/60 dark:text-[var(--text-dark)]/60 mt-10">No entries
                        yet. Start writing!</p>
                </template>
                <template :key="index" x-for="(entry, index) in entries">
                    <div class="relative group bg-[var(--primary-color)]/10 dark:bg-white/5 rounded-lg border border-[var(--primary-color)]/20 hover:border-[var(--primary-color)]/50 transition-all">
                        <div @click="selectEntry(index)" class="p-4 cursor-pointer">
                            <p class="font-bold text-lg" x-text="formatDate(entry.date, entry.editedDate)"></p>
                            <p class="text-sm text-[var(--text-light)]/80 dark:text-[var(--text-dark)]/80 mb-2"
                               x-text="new Date(entry.date).toLocaleTimeString()"></p>
                            <p class="truncate" x-text="entry.content"></p>
                        </div>
                    <button @click.stop="deleteEntry(index)"
                            class="absolute top-2 right-2 p-1.5 bg-red-500/80 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600 focus:opacity-100 focus:outline-none focus:ring-2 focus:ring-red-400">
                        <span class="material-symbols-outlined !text-base">delete</span>
                    </button>
                </template>
            </div>
        </div>
    </aside>
    <div @click="entriesSidebarOpen = false" class="fixed inset-0 bg-black/30 z-0" style="display: none;"
         x-show="entriesSidebarOpen" x-transition:enter="transition-opacity ease-linear duration-300"
         x-transition:enter-end="opacity-100" x-transition:enter-start="opacity-0"
         x-transition:leave="transition-opacity ease-linear duration-300" x-transition:leave-end="opacity-0"
         x-transition:leave-start="opacity-100"></div>
    <div class="fixed bottom-6 right-6 sm:bottom-8 sm:right-8 group">
        <div class="relative">
            <div class="absolute bottom-full right-4 mb-4 w-[min(80vw,28rem)] p-4
                bg-[var(--background-light)] dark:bg-[var(--background-dark)]
                speech-bubble transition-all duration-300"
         x-show="showCoach" x-transition>
                <div class="speech-bubble-inner relative">
                    <p class="text-base text-[var(--text-light)] dark:text-[var(--text-dark)] font-medium whitespace-pre-line"
           x-text="lastAiReply || ''"></p>
                </div>
            </div>
            <button @click="showCoach = !showCoach"
                    class="w-20 h-20 bg-[var(--primary-color)] rounded-full flex items-center justify-center text-white shadow-lg transition-all duration-300 transform group-hover:scale-110 group-hover:rotate-[-10deg] group-hover:shadow-2xl group-hover:shadow-[var(--primary-color)]/30"
                    style="border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;">
<span class="material-symbols-outlined text-4xl transform group-hover:scale-125 transition-transform duration-300">
            auto_awesome
          </span>
            </button>
        </div>
    </div>
</div>
<script>
    function journalApp() {
        return {
            user: null,
            mainMenuOpen: false,
            entriesSidebarOpen: false,
            entries: [],
            currentEntryContent: '',
            editingIndex: null,
            saving: false,
            lastAiReply: null,
            showCoach: false,

            formatDate(date, editedDate = null) {
                const opts = {year: 'numeric', month: '2-digit', day: '2-digit'};
                const base = new Date(date).toLocaleDateString('sv-SE', opts);
                if (editedDate && editedDate !== "null") {
                    const e = new Date(editedDate).toLocaleDateString('sv-SE', opts);
                    return `${base} (Edited ${e})`;
                }
                return base;
            },

            selectEntry(index) {
                this.editingIndex = index;
                this.currentEntryContent = this.entries[index].content;
                this.entriesSidebarOpen = false;
            },

            async init() {
                const raw = sessionStorage.getItem('user');
                const token = sessionStorage.getItem('token') // JWT eklediğinde kullanılır
                if (!raw /* || !token */) {
                    window.location.href = '/';
                    return;
                }
                this.user = JSON.parse(raw);

                // Entry'leri backend'den çek
                const res = await fetch(`/api/entries/${this.user.id}`);
                const rows = await res.json();
                // HTML'de entry.date kullanıldığı için created_at'i date'e map’liyoruz
                this.entries = rows.map(r => ({
                    ...r,
                    date: r.created_at,
                    ...(r.updated_at ? { editedDate: r.updated_at } : {})
                }));
                if (location.hash === '#new') {
                    this.createNewEntry();
                    // istersen textarea'ya odaklan:
                    this.$nextTick(() => {
                        const ta = document.querySelector('textarea');
                        if (ta) ta.focus();
                    });
                }
            },

            async saveEntry() {
                const content = this.currentEntryContent.trim();
                if (!content) return;
                this.saving = true;

                if (this.editingIndex !== null) {
                    // EDIT
                    const entry = this.entries[this.editingIndex];
                    const res = await fetch(`/api/entries/${entry.id}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({content})
                    });
                    if (res.ok) {
                        const updated = await res.json();
                        // listedeki öğeyi güncelle
                        this.entries[this.editingIndex] = {
                            ...entry,
                            content: updated.content,
                            date: updated.created_at,
                            editedDate: updated.updated_at || new Date().toISOString()
                        };
                        this.currentEntryContent = '';
                        this.editingIndex = null;
                    } else {
                        const data = await res.json().catch(() => ({}));
                        alert(data.error || 'Update failed');
                    }
                } else {
                    // CREATE
                    const res = await fetch('/api/entries', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({user_id: this.user.id, content})
                    });
                    if (res.ok) {
                        const created = await res.json();
                        this.entries.unshift({
                            id: created.id,
                            content: created.content,
                            date: created.created_at,
                            emotion: created.emotion,
                            ai_reply: created.ai_reply
                        });
                        this.currentEntryContent = '';
                        // AI yanıtı balonda göster
                        if (created.ai_reply) {
                            this.lastAiReply = created.ai_reply;
                            this.showCoach = true;
                            setTimeout(() => {
                                this.showCoach = false;
                            }, 20000); // 20 sn sonra gizle
                        }
                    } else {
                        const data = await res.json().catch(() => ({}));
                        alert(data.error || 'Save failed');
                    }
                }

                this.saving = false;
            },

            createNewEntry() {
                this.editingIndex = null;
                this.currentEntryContent = '';
            },
            async deleteEntry(index) {
                const entry = this.entries[index];
                if (!entry) return;

                if (!confirm('Bu entry silinsin mi?')) return;

                const res = await fetch(`/api/entries/${entry.id}?user_id=${this.user.id}`, {
                    method: 'DELETE'
                });

                if (res.status === 204) {
                    // listeden çıkar
                    this.entries.splice(index, 1);

                    // eğer tam o entry'yi editlerken sildiysek edit modunu sıfırla
                    if (this.editingIndex === index) {
                        this.editingIndex = null;
                        this.currentEntryContent = '';
                    } else if (this.editingIndex !== null && this.editingIndex > index) {
                        // listedeki indexler kaymasın
                        this.editingIndex--;
                    }
                } else {
                    const data = await res.json().catch(() => ({}));
                    alert(data.error || 'Delete failed');
                }
            },
            logout() {
                try {
                    sessionStorage.removeItem('user');   // biz şu an user'ı saklıyoruz
                    sessionStorage.removeItem('token');  // ileride JWT eklenirse burada da durur
                } catch (e) {
                }
                // İsteğe bağlı: state’i temizle
                this.entries = [];
                this.currentEntryContent = '';
                this.editingIndex = null;

                // Geri butonuyla tekrar journal'a dönülmesin istersen replace kullan
                window.location.replace('/');
                // (href de olur ama replace geçmişi de temizler)
            }
        }
    }
</script>
<script defer="" src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

</body>
</html>