<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Journal App - Profile</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Gaegu:wght@300;400;700&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
          rel="stylesheet"/>
    <style type="text/tailwindcss">
        :root {
            --primary-color: #f4b4c4;
            --background-light: #fff8f9;
            --background-dark: #2a3141;
            --text-light: #52474a;
            --text-dark: #e8dee1;
            --accent-color: #f7d9a1;
        }

        body {
            font-family: 'Gaegu', cursive;
        }

        .material-symbols-outlined {
            font-variation-settings: 'FILL' 1,
            'wght' 400,
            'GRAD' 0,
            'opsz' 24
        }

        .scribble-button {
            border: 2px solid var(--text-light);
            border-radius: 15px 225px 255px 15px 15px 255px 225px 15px;
            transition: all 0.3s ease-in-out;
        }

        .scribble-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }

        .input-scribble {
            border: 2px solid var(--text-light);
            border-radius: 255px 15px 225px 15px/15px 225px 15px 255px;
            padding: 0.75rem 1rem;
            background-color: transparent;
            transition: all 0.3s ease;
        }

        .input-scribble:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(244, 180, 196, 0.3);
        }

        .dark .scribble-button {
            border-color: var(--text-dark);
        }

        @media (prefers-color-scheme: dark) {
            .scribble-button {
                border-color: var(--text-dark);
            }
        }
    </style>
</head>
<body class="bg-[var(--background-light)] dark:bg-[var(--background-dark)] text-[var(--text-light)] dark:text-[var(--text-dark)] antialiased">
<div class="relative min-h-screen" id="app" x-data="profilePage()" x-init="init()">
    <main class="h-screen w-screen flex flex-col p-4 sm:p-6 md:p-8">
        <header class="flex-shrink-0 flex justify-between items-center pb-4">
            <div class="flex items-center gap-4">
                <div class="relative">
                    <button @click="mainMenuOpen = !mainMenuOpen"
                            class="p-3 text-[var(--text-light)] dark:text-[var(--text-dark)] hover:text-[var(--primary-color)] dark:hover:text-[var(--primary-color)] transition-colors scribble-button border-[var(--text-light)]/50 dark:border-[var(--text-dark)]/50">
<span class="material-symbols-outlined">
                menu
              </span>
                    </button>
                    <div @click.away="mainMenuOpen = false"
                         class="absolute top-full left-0 mt-2 w-48 bg-[var(--background-light)] dark:bg-[var(--background-dark)] rounded-lg shadow-lg border-2 border-[var(--primary-color)]/50"
                         style="display: none;" x-show="mainMenuOpen"
                         x-transition:enter="transition ease-out duration-200"
                         x-transition:enter-end="opacity-100 transform translate-y-0"
                         x-transition:enter-start="opacity-0 transform -translate-y-2"
                         x-transition:leave="transition ease-in duration-150"
                         x-transition:leave-end="opacity-0 transform -translate-y-2"
                         x-transition:leave-start="opacity-100 transform translate-y-0">
                        <a class="block px-4 py-3 text-lg hover:bg-[var(--primary-color)]/20 transition-colors"
                           href="#">Profile</a>
                        <button type="button"
                                @click="logout(); mainMenuOpen=false"
                                class="block w-full text-left px-4 py-3 text-lg hover:bg-[var(--primary-color)]/20 transition-colors">
                            Logout
                        </button>
                    </div>
                </div>
                <a class="p-3 text-[var(--text-light)] dark:text-[var(--text-dark)] hover:text-[var(--primary-color)] dark:hover:text-[var(--primary-color)] transition-colors scribble-button border-[var(--text-light)]/50 dark:border-[var(--text-dark)]/50"
                   href="/journal">
<span class="material-symbols-outlined">
              menu_book
            </span>
                </a>
                <a class="p-3 text-[var(--text-light)] dark:text-[var(--text-dark)] hover:text-[var(--primary-color)] dark:hover:text-[var(--primary-color)] transition-colors scribble-button border-[var(--text-light)]/50 dark:border-[var(--text-dark)]/50"
                   href="/journal#new">
<span class="material-symbols-outlined">
              add
            </span>
                </a>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-2xl font-bold text-[var(--text-light)] dark:text-[var(--text-dark)] hidden sm:block">
                    Profile Settings
                </div>
            </div>
        </header>
        <div class="flex-grow flex flex-col items-center justify-center border-t-2 border-[var(--text-light)]/10 dark:border-[var(--text-dark)]/10 pt-8">
            <div class="w-full max-w-lg p-8 bg-[var(--primary-color)]/5 dark:bg-white/5 rounded-lg border border-[var(--primary-color)]/20"
                 style="border-radius: 37px 23px 51px 19px / 23px 42px 19px 38px;">
                <div class="text-center mb-10">
<span class="material-symbols-outlined text-8xl text-[var(--primary-color)]">
              face_6
            </span>
                    <h1 class="text-4xl font-bold mt-2" x-text="profile?.name || 'Your Name'">Your Name</h1>
                    <p class="text-lg text-[var(--text-light)]/70 dark:text-[var(--text-dark)]/70"
                       x-text="profile?.member_since ? ('Member since ' + new Date(profile.member_since).getFullYear()) : 'Member since'">
                        Member since
                    </p>
                </div>
                <div class="space-y-8">
                    <div>
                        <h2 class="text-2xl font-bold mb-4 text-center">Change Password</h2>
                        <div class="space-y-4">
                            <input class="w-full text-lg input-scribble
                            bg-transparent
                            border-2 !border-[var(--text-light)] dark:!border-[var(--text-dark)]
                            text-[var(--text-light)] dark:text-[var(--text-dark)]
                            placeholder:text-[var(--text-light)] dark:placeholder:text-[var(--text-dark)]
                            focus:outline-none focus:border-[var(--primary-color)]
                            focus:ring-4 focus:ring-[var(--primary-color)] focus:ring-opacity-30 dark:focus:ring-opacity-40"
                                   x-model="currentPassword" placeholder="Current Password"
                                   type="password"/>
                            <input class="w-full text-lg input-scribble
                            bg-transparent
                            border-2 !border-[var(--text-light)] dark:!border-[var(--text-dark)]
                            text-[var(--text-light)] dark:text-[var(--text-dark)]
                            placeholder:text-[var(--text-light)] dark:placeholder:text-[var(--text-dark)]
                            focus:outline-none focus:border-[var(--primary-color)]
                            focus:ring-4 focus:ring-[var(--primary-color)] focus:ring-opacity-30 dark:focus:ring-opacity-40"
                                   x-model="newPassword" placeholder="New Password" type="password"/>
                            <input class="w-full text-lg input-scribble
                            bg-transparent
                            border-2 !border-[var(--text-light)] dark:!border-[var(--text-dark)]
                            text-[var(--text-light)] dark:text-[var(--text-dark)]
                            placeholder:text-[var(--text-light)] dark:placeholder:text-[var(--text-dark)]
                            focus:outline-none focus:border-[var(--primary-color)]
                            focus:ring-4 focus:ring-[var(--primary-color)] focus:ring-opacity-30 dark:focus:ring-opacity-40"
                                   x-model="confirmPassword" placeholder="Confirm New Password"
                                   type="password"/>
                        </div>
                        <div class="text-center mt-6">
                            <button @click="updatePassword"
                                    class="scribble-button bg-[var(--primary-color)]/80 hover:bg-[var(--primary-color)] text-[var(--text-light)] dark:text-[var(--text-dark)] font-bold py-3 px-8 text-lg transition-all">
                                Update Password
                            </button>

                        </div>
                    </div>
                    <div class="border-t-2 border-dashed border-[var(--text-light)]/20 dark:border-[var(--text-dark)]/20 my-8"></div>
                    <div>
                        <h2 class="text-2xl font-bold mb-4 text-center text-red-500/80">Danger Zone</h2>
                        <div class="text-center bg-red-500/10 p-6 rounded-lg border-2 border-dashed border-red-500/30"
                             style="border-radius: 255px 15px 225px 15px/15px 225px 15px 255px;">
                            <p class="mb-4 text-lg">Once you delete your account, there is no going back. Please be
                                certain.</p>
                            <button @click="deleteAccount"
                                    class="scribble-button bg-red-500/80 hover:bg-red-600 text-white font-bold py-3 px-8 text-lg transition-all border-red-700">
                                Delete My Account
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>
<script>
    function profilePage() {
        return {
            mainMenuOpen: false,
            user: null,
            profile: null,
            currentPassword: '',
            newPassword: '',
            confirmPassword: '',
            loading: false,

            // localStorage kullanıyorsan: storageGet = () => localStorage.getItem('user')
            storageGet() {
                return sessionStorage.getItem('user') || localStorage.getItem('user');
            },

            async init() {
                const raw = this.storageGet();
                if (!raw) {
                    window.location.replace('/');
                    return;
                }
                this.user = JSON.parse(raw);

                // Profili çek
                try {
                    const res = await fetch(`/api/users/${this.user.id}`);
                    if (res.ok) {
                        this.profile = await res.json();
                    }
                } catch (e) {
                    console.error(e);
                }
            },

            async updatePassword() {
                if (!this.currentPassword || !this.newPassword) {
                    alert('Please fill current and new password.');
                    return;
                }
                if (this.newPassword !== this.confirmPassword) {
                    alert('New passwords do not match.');
                    return;
                }
                this.loading = true;
                try {
                    const res = await fetch(`/api/users/${this.user.id}/password`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            current_password: this.currentPassword,
                            new_password: this.newPassword
                        })
                    });
                    if (res.ok) {
                        alert('Password updated ✓');
                        this.currentPassword = this.newPassword = this.confirmPassword = '';
                    } else {
                        const data = await res.json().catch(() => ({}));
                        alert(data.error || 'Password update failed');
                    }
                } catch (e) {
                    alert('Network error');
                } finally {
                    this.loading = false;
                }
            },

            async deleteAccount() {
                if (!confirm('This will permanently delete your account and entries. Continue?')) return;

                const pwd = prompt('Please type your CURRENT password to confirm:');
                if (!pwd) return;

                this.loading = true;
                try {
                    const res = await fetch(`/api/users/${this.user.id}`, {
                        method: 'DELETE',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({current_password: pwd})
                    });
                    if (res.status === 204) {
                        // Storage temizle ve ana sayfaya dön
                        try {
                            sessionStorage.removeItem('user');
                            sessionStorage.removeItem('token');
                            localStorage.removeItem('user');
                            localStorage.removeItem('token');
                        } catch (e) {
                        }
                        window.location.replace('/');
                    } else {
                        const data = await res.json().catch(() => ({}));
                        alert(data.error || 'Delete failed');
                    }
                } catch (e) {
                    alert('Network error');
                } finally {
                    this.loading = false;
                }
            },

            logout() {
                try {
                    sessionStorage.removeItem('user');
                    sessionStorage.removeItem('token');
                    localStorage.removeItem('user');
                    localStorage.removeItem('token');
                } catch (e) {
                }
                window.location.replace('/'); // geçmişi temizleyerek ana sayfaya dön
            }
        }
    }
</script>

<script defer="" src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

</body>
</html>